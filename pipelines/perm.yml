resource_types:
- name: gcs
  type: docker-image
  source:
    repository: frodenas/gcs-resource
- name: git-branch-heads
  type: docker-image
  source:
    repository: vito/git-branch-heads-resource

resources:
- name: perm-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/perm-ci
    branch: master
    private_key: ((github.private_key))
- name: perm
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/perm
    branch: master
    private_key: ((github.private_key))
- name: perm-release
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/perm-release
    branch: master
    private_key: ((github.private_key))
- name: version
  type: semver
  source:
    driver: s3
    endpoint: storage.googleapis.com
    initial_version: 0.0.0
    bucket: perm-releases
    key: version
    access_key_id: ((gcp.access_key_id))
    secret_access_key: ((gcp.secret_access_key))
- name: release-alpha
  type: gcs
  source:
    bucket: perm-alphas
    regexp: perm-release-(.*).tgz
    json_key: ((gcp.json_key))
- name: perm-rb
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/perm-rb
    branch: master
    private_key: ((github.private_key))
- name: binary-alpha
  type: gcs
  source:
    bucket: perm-alphas
    regexp: perm-(\d+\.\d+\.\d+.*).tgz
    json_key: ((gcp.json_key))
- name: capi-release-alpha
  type: gcs
  source:
    bucket: perm-alphas
    regexp: capi-release-(\d*)-.*-for-perm-.*.tgz
    json_key: ((gcp.json_key))
- name: capi-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/capi-ci
    branch: master
    private_key: ((github.private_key))
- name: cloud_controller_ng-perm-prs
  type: git-branch-heads
  source:
    uri: git@github.com:cloudfoundry/cloud_controller_ng
    branches:
    - perm/*
    private_key: ((github.private_key))
- name: capi-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/capi-release
    branch: develop
    private_key: ((github.private_key))

jobs:
- name: test-server
  plan:
  - aggregate:
    - get: perm-ci
    - get: perm
      trigger: true
  - task: test-server
    file: perm-ci/tasks/test-server/task.yml

- name: bump-submodule
  plan:
  - aggregate:
    - get: perm-ci
    - get: perm-release
    - get: perm
      passed:
      - test-server
      trigger: true
  - task: bump-submodule
    file: perm-ci/tasks/bump-submodule/task.yml
    input_mapping:
      parent-repo: perm-release
      submodule-repo: perm
    output_mapping:
      updated-parent-repo: updated-perm-release
    params:
      SUBMODULE_PATH: src/code.cloudfoundry.org/perm
      SUBMODULE_NAME: perm
  - put: perm-release
    params:
      repository: updated-perm-release/parent-repo
      rebase: true

- name: bump-alpha
  plan:
  - aggregate:
    - get: perm
      passed:
      - bump-submodule
    - get: version
      params:
        pre: alpha
    - get: perm-release
      trigger: true
  - put: version
    params:
      file: version/version

- name: create-alpha
  plan:
  - aggregate:
    - get: version
      passed:
      - bump-alpha
      trigger: true
    - get: perm-release
      passed:
      - bump-alpha
      trigger: true
    - get: perm-ci
  - aggregate:
    - task: build-perm-binary
      file: perm-ci/tasks/build-binary/task.yml
      input_mapping:
        release: perm-release
      output_mapping:
        bin-dir: perm-bin-dir
      params:
        PACKAGE_PATH: code.cloudfoundry.org/perm/cmd/perm
        BINARY_NAME: perm
    - task: create-release
      file: perm-ci/tasks/create-release/task.yml
      input_mapping:
        release: perm-release
      params:
        RELEASE_NAME: perm
        TARBALL_NAME: perm-release
  - put: release-alpha
    params:
      file: release-output/perm-*.tgz
  - put: binary-alpha
    params:
      file: perm-bin-dir/perm-*.tgz

- name: test-ruby-client
  plan:
  - aggregate:
    - get: perm-rb
      trigger: true
    - get: perm-bin-dir
      resource: binary-alpha
      passed:
      - create-alpha
      trigger: true
    - get: release-alpha
      passed:
      - create-alpha
    - get: perm-ci
    - get: version
  - task: test-ruby-client
    file: perm-ci/tasks/test-ruby-client/task.yml

- name: test-capi
  plan:
  - aggregate:
    - get: perm-ci
    - get: capi-ci
    - get: perm-bin-dir
      resource: binary-alpha
      passed:
      - test-ruby-client
    - get: release-alpha
      passed:
      - test-ruby-client
    - get: version
    - get: cloud_controller_ng
      resource: cloud_controller_ng-perm-prs
      trigger: true
      version: every
  - task: test-capi
    file: perm-ci/tasks/test-capi/task.yml

- name: create-capi-alpha
  plan:
  - aggregate:
    - get: perm-ci
    - get: version
      passed:
      - test-capi
    - get: capi-release
      resource: capi-release-develop
    - get: cloud_controller_ng
      resource: cloud_controller_ng-perm-prs
      trigger: true
      version: every
      passed:
      - test-capi
    - get: release-alpha
      passed:
      - test-capi
  - aggregate:
    - task: bump-submodule
      file: perm-ci/tasks/bump-submodule/task.yml
      input_mapping:
        parent-repo: capi-release
        submodule-repo: cloud_controller_ng
      output_mapping:
        updated-parent-repo: updated-capi-release-dir
      params:
        SUBMODULE_PATH: src/cloud_controller_ng
        SUBMODULE_NAME: cloud_controller_ng
    - task: get-branch-name
      file: perm-ci/tasks/get-branch-name/task.yml
      input_mapping:
        repo: cloud_controller_ng
  - task: create-capi-release
    file: perm-ci/tasks/create-capi-release/task.yml
    input_mapping:
      release-dir: updated-capi-release-dir
    params:
      RELEASE_NAME: capi
  - put: capi-release-alpha
    params:
      file: release-output/capi-release-*.tgz
