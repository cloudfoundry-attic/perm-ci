resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource

- name: cron
  type: docker-image
  source:
    repository: cftoolsmiths/cron-resource

resources:
- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bosh-deployment.git
    private_key: ((github.private_key))

- name: break-bosh-lites-trigger
  type: cron
  source:
    expression: 0 0 0/1 1/1 * ? *
    location: America/Los_Angeles
    fire_immediately: true

- name: broken-bosh-lites-trigger
  type: git
  source:
    branch: master
    uri: ((broken_pool_repo_uri))
    private_key: ((github.private_key))
    paths:
    - bosh-lites-broken/trigger

- name: broken-pool
  type: pool
  source:
    uri: ((broken_pool_repo_uri))
    branch: master
    private_key: ((github.private_key))
    pool: bosh-lites-broken

- name: broken-pool-repo
  type: git
  source:
    branch: master
    uri: ((broken_pool_repo_uri))
    private_key: ((github.private_key))

- name: capi-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/capi-ci
    branch: master
    private_key: ((github.private_key))

- name: terraform
  type: terraform
  source:
    storage:
      endpoint: storage.googleapis.com
      bucket: ((terraform.bucket))
      bucket_path: bosh-lite/
      access_key_id: ((gcp.access_key_id))
      secret_access_key: ((gcp.secret_access_key))

jobs:
- name: break-bosh-lites
  plan:
  - aggregate:
    - get: break-bosh-lites-trigger
      trigger: true
    - get: broken-pool-repo
  - task: do-trigger-stuff
    params:
      POOL_NAME: bosh-lites-broken
      TRIGGER_PATH: bosh-lites-broken/trigger
    input_mapping:
      pool-repo: broken-pool-repo
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: concourse/buildroot
          tag: git
      inputs:
      - name: pool-repo
      outputs:
      - name: updated-pool-repo-dir
      params:
        GIT_COMMIT_EMAIL: cf-permissions@pivotal.io
        GIT_COMMIT_USERNAME: CI Bot
        POOL_NAME:
        TRIGGER_PATH:
      run:
        path: bash
        args:
        - -c
        - |
          set -eu

          TRIGGER_PATH="${PWD}/updated-pool-repo-dir/repo/${TRIGGER_PATH}"

          git clone pool-repo updated-pool-repo-dir/repo

          pushd updated-pool-repo-dir/repo
            git config user.name "$GIT_COMMIT_USERNAME"
            git config user.email "$GIT_COMMIT_EMAIL"

            # If there are no files in the glob it will expand to the directory path
            # Prevent this behavior: https://www.cyberciti.biz/faq/bash-loop-over-file/
            shopt -s nullglob

            for env_path in "${PWD}/${POOL_NAME}/pending/"*; do
              env="$(basename "$env_path")"

              git mv "${env_path}" "./${POOL_NAME}/unclaimed"
              git commit -m "Break $env"

              echo "$env" > "${TRIGGER_PATH}"

              git add "${TRIGGER_PATH}"
              git commit -m "Trigger destruction of $env"
            done
          popd
  - put: broken-pool-repo
    params:
      repository: updated-pool-repo-dir/repo

- name: destroy-bosh-lites
  plan:
  - get: broken-bosh-lites-trigger
    trigger: true
  - aggregate:
    - get: bosh-deployment
    - put: broken-pool
      params:
        acquire: true
    - get: capi-ci
  - task: download-from-gcs
    file: capi-ci/ci/gcs/download-from-gcs.yml
    input_mapping:
      environment: broken-pool
    output_mapping:
      destination-directory: director-state
    params: &gcp-environment-params
      GCP_JSON_KEY: ((gcp.json_key))
      GCP_BUCKET: ((terraform.bucket))
      GCP_PATH: director-state
      USE_ENV_NAMED_SUBDIR: true
  - task: delete-bosh-lite
    file: capi-ci/ci/bosh-lite/delete-bosh-lite.yml
  - put: terraform
    params:
      action: destroy
      env_name_file: broken-pool/name
      terraform_source: capi-ci/terraform/bosh-lite/
      vars:
        project_id: ((gcp.project_id))
        json_key: ((gcp.json_key))
        dns_project_id: ((gcp.project_id))
        dns_json_key: ((gcp.json_key))
        system_domain_suffix: ((terraform.system_domain_suffix))
        dns_zone_name: ((terraform.dns_zone_name))
        region: ((gcp.region))
        zone: ((gcp.zone))
    get_params:
      action: destroy
  - task: delete-from-gcs
    file: capi-ci/ci/gcs/delete-from-gcs.yml
    input_mapping:
      environment: broken-pool
    params: *gcp-environment-params
  - put: broken-pool
    params:
      remove: broken-pool/
