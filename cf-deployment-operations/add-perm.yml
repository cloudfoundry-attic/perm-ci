# Perm Service

- type: replace
  path: /instance_groups/-
  value:
    name: perm
    instances: 1
    azs: [z1]
    vm_type: minimal
    stemcell: default
    networks:
    - name: default
    jobs:
    - name: perm
      release: perm
      properties:
        log_level: debug
        tls: ((perm-tls))
        sql:
          db:
            driver: mysql
            username: perm
            password: ((perm-database_password))
            schema: perm
            host: sql-db.service.cf.internal
            port: 3306
          tls:
            required: true
            ca_certs:
            - ((perm-mysql-tls.ca))

# Changes to other instance groups
- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/seeded_databases/-
  value:
    name: perm
    password: ((perm-database_password))
    username: perm

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/ca_certificate
  value: ((perm-mysql-tls.ca))

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/server_certificate
  value: ((perm-mysql-tls.certificate))

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/server_key
  value: ((perm-mysql-tls.private_key))

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/properties?/perm
  value:
    ca_certs:
    - ((perm-tls.ca))

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/properties/perm?/enabled
  value: true

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/properties/perm?/query_enabled
  value: true

- type: replace
  path: /addons/name=bosh-dns/jobs/name=bosh-dns/properties/aliases/perm.service.cf.internal?
  value:
    - "*.perm.default.cf.bosh"

# Changes to releases
- type: replace
  path: /releases/-
  value:
    name: perm
    version: ((perm_version))

# Changes to variables
- type: replace
  path: /variables/-
  value:
    name: perm-tls-ca
    type: certificate
    options:
      is_ca: true
      common_name: perm_ca

- type: replace
  path: /variables/-
  value:
    name: perm-tls
    type: certificate
    options:
      ca: perm-tls-ca
      common_name: perm.service.cf.internal
      extended_key_usage:
      - client_auth
      - server_auth

- type: replace
  path: /variables/-
  value:
    name: perm-mysql-tls-ca
    type: certificate
    options:
      is_ca: true
      common_name: perm_mysql_ca

- type: replace
  path: /variables/-
  value:
    name: perm-mysql-tls
    type: certificate
    options:
      ca: perm-mysql-tls-ca
      common_name: sql-db.service.cf.internal

- type: replace
  path: /variables/-
  value:
    name: perm-database_password
    type: password


# Perm Errands

- type: replace
  path: /instance_groups/-
  value:
    name: perm-drop-database
    instances: 1
    azs: [z1]
    lifecycle: errand
    vm_type: minimal
    stemcell: default
    networks:
    - name: default
    jobs:
    - name: perm-drop-db
      release: perm
      properties:
        sql:
          db:
            driver: mysql
            username: perm
            password: ((perm-database_password))
            schema: perm
            host: sql-db.service.cf.internal
            port: 3306

- type: replace
  path: /instance_groups/-
  value:
    name: capi-perm-migrator
    instances: 1
    azs: [z1]
    lifecycle: errand
    vm_type: minimal
    stemcell: default
    networks:
    - name: default
    jobs:
    - name: cc-to-perm-migrator
      release: perm
      properties:
        uaa:
          hostname: uaa.((system_domain))
          port: 443
          ca_certs:
          - ((router_ssl.ca))

        cloud_controller:
          hostname: api.((system_domain))
          port: 443
          client_id: cloud-controller-monitor
          client_secret: ((perm_uaa_clients_cloud_controller_monitor_secret))
          client_scopes:
          - cloud_controller.admin_read_only

        perm:
          ca_certs:
          - ((perm-tls.ca))
        sql:
          db:
            driver: mysql
            username: perm
            password: ((perm-database_password))
            schema: perm
            host: sql-db.service.cf.internal
            port: 3306

- type: replace
  path: /instance_groups/name=uaa/jobs/name=uaa/properties/uaa?/clients/cloud-controller-monitor?
  value:
    authorities: cloud_controller.admin_read_only
    authorized-grant-types: client_credentials
    secret: ((perm_uaa_clients_cloud_controller_monitor_secret))

- type: replace
  path: /variables/-
  value:
    name: perm_uaa_clients_cloud_controller_monitor_secret
    type: password
