# Perm instance group
- type: replace
  path: /instance_groups/-
  value:
    name: perm
    instances: 1
    azs: [z1]
    vm_type: minimal
    stemcell: default
    networks:
    - name: default
    jobs:
    - name: perm
      release: perm
      properties:
        log_level: debug
        tls: ((perm/tls))
        sql:
          db:
            driver: mysql
            username: perm
            password: ((perm/database_password))
            schema: perm
            host: sql-db.service.cf.internal
            port: 3306
          tls:
            required: true
            ca_certs:
            - ((perm/mysql-tls.ca))

# Changes to other instance groups
- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/seeded_databases/-
  value:
    name: perm
    password: ((perm/database_password))
    username: perm

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/ca_certificate
  value: ((perm/mysql-tls.ca))

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/server_certificate
  value: ((perm/mysql-tls.certificate))

- type: replace
  path: /instance_groups/name=database?/jobs/name=mysql/properties/cf_mysql/mysql/tls?/server_key
  value: ((perm/mysql-tls.private_key))

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/properties?/perm
  value:
    ca_certs:
    - ((perm/tls.ca))

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/properties/perm?/enabled
  value: true

# Changes to releases
- type: replace
  path: /releases/-
  value:
    name: perm
    version: ((perm_version))

# Changes to variables
- type: replace
  path: /variables/-
  value:
    name: perm/tls-ca
    type: certificate
    options:
      is_ca: true
      common_name: perm_ca

- type: replace
  path: /variables/-
  value:
    name: perm/tls
    type: certificate
    options:
      ca: perm/tls-ca
      common_name: perm.service.cf.internal
      extended_key_usage:
      - client_auth
      - server_auth

- type: replace
  path: /variables/-
  value:
    name: perm/mysql-tls-ca
    type: certificate
    options:
      is_ca: true
      common_name: perm_mysql_ca

- type: replace
  path: /variables/-
  value:
    name: perm/mysql-tls
    type: certificate
    options:
      ca: perm/mysql-tls-ca
      common_name: sql-db.service.cf.internal

- type: replace
  path: /variables/-
  value:
    name: perm/database_password
    type: password
